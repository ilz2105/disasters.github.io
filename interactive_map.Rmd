---
title: "Interactive Map"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
    source_code: embed
runtime: shiny
---

```{r setup, include=FALSE}
library(flexdashboard)
library(shiny)
library(plotly)
library(tidyverse)
library(rvest)

# read in data
ave_temp = read_csv("https://www.ncdc.noaa.gov/cag/statewide/mapping/110-tavg.csv", skip = 3) %>% 
  janitor::clean_names() %>% 
  separate(date, into = c("year", "month"), sep = 4) %>%
  mutate(
    year = as.numeric(year), 
    state_code = setNames(state.abb, state.name)[location]) %>% 
  filter(year >= 1953 & year <= 2018) %>% 
  group_by(location, year) %>% 
  mutate(
    mean_temp = mean(value)) %>% 
  select(state_code, location, year, mean_temp) %>% 
  distinct()

precip = read_csv("https://www.ncdc.noaa.gov/cag/statewide/mapping/110-pcp.csv", skip = 3) %>% 
  janitor::clean_names() %>% 
  separate(date, into = c("year", "month"), sep = 4) %>%
 mutate(
    year = as.numeric(year), 
    state_code = setNames(state.abb, state.name)[location]) %>% 
  filter(year >= 1953 & year <= 2018) %>% 
  group_by(location, year) %>% 
  mutate(
    total_precip = sum(value)) %>% 
  select(state_code, location, year, total_precip) %>% 
  distinct()

tmax = read_csv("https://www.ncdc.noaa.gov/cag/statewide/mapping/110-tmax.csv", skip = 3) %>% 
  janitor::clean_names() %>% 
  separate(date, into = c("year", "month"), sep = 4) %>%
 mutate(
    year = as.numeric(year), 
    state_code = setNames(state.abb, state.name)[location]) %>% 
  filter(year >= 1953 & year <= 2018) %>% 
  group_by(location, year) %>% 
  mutate(
    max_temp = max(value)) %>% 
  select(state_code, location, year, max_temp) %>% 
  distinct()

tmin = read_csv("https://www.ncdc.noaa.gov/cag/statewide/mapping/110-tmin.csv", skip = 3)  %>% 
  janitor::clean_names() %>% 
  separate(date, into = c("year", "month"), sep = 4) %>%
 mutate(
    year = as.numeric(year), 
    state_code = setNames(state.abb, state.name)[location]) %>% 
  filter(year >= 1953 & year <= 2018) %>% 
  group_by(location, year) %>% 
  mutate(
    min_temp = min(value)) %>% 
  select(state_code, location, year, min_temp) %>% 
  distinct()

disasters = read_csv("./data/DisasterDeclarationsSummaries2.csv") %>% 
  janitor::clean_names() %>% 
  mutate(disaster = factor(incident_type)) %>% 
  rename(
     year = fy_declared) %>% 
  filter(year >= 1953 & year <= 2018) %>% 
  count(state, year, disaster) %>%
  group_by(year, state) %>% 
  mutate(
    n_state = sum(n)
  ) %>% 
  group_by(year) %>% 
  mutate(
    n_total = sum(n)
  ) %>% 
  group_by(year, disaster) %>% 
  mutate(
    n_type = sum(n)
  ) %>% 
  rename("n_disaster_state" = "n") 

final_data = 
  inner_join(ave_temp, precip, by = c("location" = "location", "year" = "year", "state_code" = "state_code")) %>% 
  inner_join(tmax, by = c("location" = "location", "year" = "year", "state_code" = "state_code")) %>% 
  inner_join(tmin, by = c("location" = "location", "year" = "year", "state_code" = "state_code")) %>% 
  full_join(disasters, by = c("year" = "year", "state_code" = "state"))
```

### I have no idea if this will be needed, but I have included it here if it is. Run without it first and then go from there. I think it was just used to fill in missing years before, so it shouldn't be needed for us. Left out the r on purpose in the code chunk to make sure not to run it.
``` {}
map_data = disasters_count %>%
	filter(year >= 1953, year =< 2019) %>%
	mutate(year = paste("year", year, sep = "_")) %>%
	spread(key = year, value = Statistics) %>%
	gather(key = year, value = Statistics, year_1953:year_2019) %>%
	mutate(year = as.numeric(str_extract(year, "[0-9]{4}")))
```

Disaster Map
===================================== 

Column {.sidebar}
-----------------------------------------------------------------------


```{r for_sidebar}

# entries to select from -- Matt Note: type_variable may have to be created. I think it is a new variable to describe things like "temp variable" or "disaster variable".
type_variable <- (final_data %>% distinct(type_variable) %>% pull())
year <- c(1953:2019)

# year select box -- Matt Note: may have to make variable name year_1 using our final data and mutating further in a previous step. Slightly unclear.  
selectInput("year_1", label = h3("Choose year"),
						choices = as.list(year),
						selected = 2019)

# variable select box -- Matt Note: Same as above for variable type. 
selectInput("variable_type", label = h3("Choose variable"),
						choices = type_variable, selected = "disaster")
# Matt Note: Definitely seems like type_variable is something that does not exist in our data and we will have to find a proxy or make a new variable. Once we have our data again this shouldn't be too hard I believe.
```



(See description page for more information.)

Column {.tabset}
-----------------------------------------------------------------------

### US MAP

```{r us_map}
# convert state abbreviations to state names -- Might need a slight tweak depending on our variable names for states.
state_abb <- state.name
names(state_abb) <- state.abb

# plot_geo
renderPlotly({
	# map plot settings -- This should be good to go. Maybe the scope is different but I think this wll work.
	geo1 <- list(
	scope = "usa",
	projection = list(type = "state"),
	showlakes = TRUE,
	lakecolor = toRGB("white")
	)
	
	# display values using color intensity -- This should also be good to go if previous code chunk works.
	final_data %>% 
	filter(type_variable == input$variable_type, year == input$year_1) %>% 
	plot_geo(locationmode = "USA-states") %>% 
	add_trace(
		z = ~Statistics,
		locations = ~state,
		color = ~Statistics,
		colors = "Reds",
		# add text
		text = ~paste(type_variable, state_abb[state], sep = "")
		) %>%
	layout(
		geo = geo1,
		title = "US Map - State Disaster Statistics",
		legend = list(x = 100, y = 0.5)
	)
})

```

### Description

The Disaster Map allows users to select different years (1953-2019), demonstrating the changes in variables over time and visualize differences across the country. The map includes the following variables:

* **Disaster Declarations**: Darker areas represent higher counts of disasters, hovering over each state will display the counts.

* **Climate Indicators**:
  + **Average Temperature**: Darker areas represent a higher average temperature in that state across all 12 months of the year that was summarized. Hovering over each state will display the average temperature.
  + **Minimum Temperature**: Darker areas represent a higher minimum temperature in that state across all 12 months of the year that was summarized. Hovering over each state will display the minimum temperature.
  + **Maximum Temperature**: Darker areas represent a higher maximum temperature in that state across all 12 months of the year that was summarized. Hovering over each state will display the maximum temperature.
  + **Total Precipitation**: Darker areas represent a higher total precipitation in that state across all 12 months of the year that was summarized. Hovering over each state will display the total precipitation.
