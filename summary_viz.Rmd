---
title: "Summary Visualizations"
output: 
  html_document:
    toc: true
    toc_float: true
    theme: flatly
---

```{r}
library(tidyverse)
library(ggridges)
library(plotly)
```

```{r setup, echo = FALSE, warning = FALSE, message = FALSE}
library(tidyverse)
library(rvest)

ave_temp = read_csv("https://www.ncdc.noaa.gov/cag/statewide/mapping/110-tavg.csv", skip = 3) %>% 
  janitor::clean_names() %>% 
  separate(date, into = c("year", "month"), sep = 4) %>%
  mutate(
    year = as.numeric(year), 
    state_code = setNames(state.abb, state.name)[location]) %>% 
  filter(year >= 1953 & year <= 2018) %>% 
  group_by(location, year) %>% 
  mutate(
    mean_temp = mean(value)) %>% 
  select(state_code, location, year, mean_temp) %>% 
  distinct()

precip = read_csv("https://www.ncdc.noaa.gov/cag/statewide/mapping/110-pcp.csv", skip = 3) %>% 
  janitor::clean_names() %>% 
  separate(date, into = c("year", "month"), sep = 4) %>%
 mutate(
    year = as.numeric(year), 
    state_code = setNames(state.abb, state.name)[location]) %>% 
  filter(year >= 1953 & year <= 2018) %>% 
  group_by(location, year) %>% 
  mutate(
    total_precip = sum(value)) %>% 
  select(state_code, location, year, total_precip) %>% 
  distinct()

tmax = read_csv("https://www.ncdc.noaa.gov/cag/statewide/mapping/110-tmax.csv", skip = 3) %>% 
  janitor::clean_names() %>% 
  separate(date, into = c("year", "month"), sep = 4) %>%
 mutate(
    year = as.numeric(year), 
    state_code = setNames(state.abb, state.name)[location]) %>% 
  filter(year >= 1953 & year <= 2018) %>% 
  group_by(location, year) %>% 
  mutate(
    max_temp = max(value)) %>% 
  select(state_code, location, year, max_temp) %>% 
  distinct()

tmin = read_csv("https://www.ncdc.noaa.gov/cag/statewide/mapping/110-tmin.csv", skip = 3)  %>% 
  janitor::clean_names() %>% 
  separate(date, into = c("year", "month"), sep = 4) %>%
 mutate(
    year = as.numeric(year), 
    state_code = setNames(state.abb, state.name)[location]) %>% 
  filter(year >= 1953 & year <= 2018) %>% 
  group_by(location, year) %>% 
  mutate(
    min_temp = min(value)) %>% 
  select(state_code, location, year, min_temp) %>% 
  distinct()

disasters = read_csv("./data/DisasterDeclarationsSummaries2.csv") %>% 
  janitor::clean_names() %>% 
  mutate(disaster = factor(incident_type)) %>% 
  rename(
     year = fy_declared) %>% 
  filter(year >= 1953 & year <= 2018) %>% 
  count(state, year, disaster) %>%
  group_by(year, state) %>% 
  mutate(
    n_state = sum(n)
  ) %>% 
  group_by(year) %>% 
  mutate(
    n_total = sum(n)
  ) %>% 
  group_by(year, disaster) %>% 
  mutate(
    n_type = sum(n)
  ) %>% 
  rename("n_disaster_state" = "n") 

final_data = 
  inner_join(ave_temp, precip, by = c("location" = "location", "year" = "year", "state_code" = "state_code")) %>% 
  inner_join(tmax, by = c("location" = "location", "year" = "year", "state_code" = "state_code")) %>% 
  inner_join(tmin, by = c("location" = "location", "year" = "year", "state_code" = "state_code")) %>% 
  full_join(disasters, by = c("year" = "year", "state_code" = "state"))
```


```{r}
final_data = final_data %>% 
mutate(
  region = case_when(
    location %in% c(
                    "Alabama","Arkansas","Delaware","Florida","Georgia"
                    ,"Kentucky","Louisiana","Maryland","Mississippi",
                    "Oklahoma","North Carolina","South Carolina",
                    "Tennessee","Texas","Virginia","West Virginia") ~ "southeast",
   location %in% c("Connecticut","Maine","New Hampshire","Massachusetts",
                   "New Jersey","New York","Pennsylvania","Rhode Island","Vermont") ~ 'northeast',
  location %in% c("Alaska", 
                "Arizona","California","Colorado","Hawaii","Idaho",
                "Montana","Nevada","New Mexico","Oregon","Utah","Washington","Wyoming")
       ~  'west',
  location %in% c("Illinois",
                "Indiana","Iowa","Kansas","Michigan","Missouri",
                "Minnesota","Nebraska","North Dakota","Ohio","South Dakota", "Wisconsin") ~ 'midwest'))
  
 
   
```


```{r, scatterplot}

final_data %>% 
  drop_na() %>% 
  ggplot(aes(x = year, y = mean_temp, group = region, color = region))+
  geom_point(aes(color = region), alpha = 0.2)+
  geom_smooth( se = FALSE, alpha = 4)+
  labs(title = "Average Temps(F) by Region from 1953-2018", 
       xlab = "Year",
       ylab = "Average Temperature(F)")+
  theme_bw()+
  theme(legend.position = "left")

# plotly verson of above scatterplot
final_data %>% 
  mutate(text_label = str_c("avg temp (F): ", mean_temp,   "\n", location)) %>% 
  plot_ly(
    x = ~year, y = ~mean_temp, type = "scatter", mode = "markers",
    color = ~region, text = ~text_label, alpha = 0.5)
```
This scatterplot shows the average temperature (F) from 1953 to 2018, by region. Overall, the southeast region has the highest average temperatures and the Northeast has the lowest average temperatures.Though it may be hard to see,
the average temperature increased from 70.81F to 72.28F from 1953 to 2018 in the Southeast, 59.25F to 62.26F in the Southwest, 


```{r, density}
# trying to make a panel of all 50 states showing # disasters over year
final_data %>% 
  group_by( disaster, region)%>% 
  select(region, disaster, year, n_total)%>% 
  drop_na() %>% 
  ggplot(aes(x = year, y = n_total, color = disaster)) +
  geom_line(alpha = 0.2)+
  geom_smooth( se = FALSE)+
  theme(aspect.ratio = 1, axis.text.x = element_text(angle = 90,  hjust = 1))+
  facet_wrap(~region)+
  labs(title = "",
       xlab = "Year",
       ylab = "Frequency of Disasters")
```

This is a panel showing the total number of disasters from 1953-2018 for each reagion. The disasters are shown in different colors. 

# regional?


```{r}
final_data %>% 
  drop_na(disaster) %>% 
  #summarize(total_d = sum(n_total)) %>% 
  ggplot(aes(x = disaster, fill = disaster ))+
  geom_histogram(stat = "count" , position = "dodge", binwidth = 2) +
  theme(axis.text.x = element_text(angle = 90,  hjust = 1))+
  labs(title = "Frequency of Types of Disaster")
```

This plot shows the 

```{r}

final_data %>% 
  drop_na(disaster) %>% 
  ggplot(aes(x = year, fill = region))+
  geom_bar()+
  labs(title = "Number of Disasters Per Year From 1953-2018")
```

```{r}

final_data %>%
  group_by(year, region) %>% 
  drop_na( ) %>% 
  ggplot(aes(x= year, y = mean_temp))+
    geom_line(aes(group = region, color = region))+
  labs(title = "Spaghetti Plot Showing Average Temps from 1953-2018 By Region")
```


```{r}
final_data %>%
  group_by(year, location) %>% 
  ggplot(aes(x= year, y = total_precip))+
    geom_line(aes(group = location, color = location))+
  labs(title = "Spaghetti Plot Showing Total Precipitation from 1953-2018 By State")
```
---
# Matt Note -  this part is creating issues so removed it for now to see if website can build.
final_data %>% 
  group_by(year, location, mean_temp, total_precip) %>% 
mutate(text_label = str_c("avg temp (F): ", mean_temp, '\ntotal precip(in): ', total_precip,  "\n", location)) %>% 
  plot_ly(
    x = ~year, y = ~total_precip, type = "scatter", mode = "markers",
    color = ~location, text = ~text_label, alpha = 0.5)+
  labs(title = "Total Precipitation(in.) by Year For Each State")


```{r}
final_data %>% 
  group_by(year, location, disaster) %>% 
mutate(text_label = str_c( disaster, '\ntotal precip(in): ', total_precip,  "\n", location)) %>% 
  plot_ly(
    x = ~disaster, y = ~n_total, type = "box",
    color = ~disaster, text = ~text_label, alpha = 0.5)
```

```{r}
final_data %>% 
  group_by(location) %>% 
  filter(n_state)
  mutate(text_label = str_c(year, "\ntotal: ",n_total)) %>% 
plot_ly(
    x = ~location, y = ~disaster, type = "bar",
    color = ~disaster, text = ~text_label, alpha = 0.5)
```



